<?php

declare(strict_types=1);

namespace Tests\Daniel\Library\Application\Find;

use Medine\Daniel\Library\Application\Find\BookFinder;
use Medine\Daniel\Library\Application\Find\BookNotExistsException;
use Medine\Daniel\Library\Domain\Contracts\BookRepository;
use PHPUnit\Framework\TestCase;
use Tests\Daniel\Library\Domain\BookMother;

final class BookFinderTest extends TestCase
{
    protected function tearDown(): void
    {
        parent::tearDown(); // TODO: Change the autogenerated stub
        \Mockery::close();
    }

    /**
     * @test
     */
    public function itShouldFindAnExistingBook(): void
    {
        $book       = BookMother::random();
        $repository = \Mockery::mock(BookRepository::class);
        $finder     = new BookFinder($repository);
        $request    = BookFinderRequestMother::fromEntity($book);

        $repository->shouldReceive('find')
            ->with($book->id())
            ->once()
            ->andReturn($book);

        $response = ($finder)($request);

        $this->assertEquals($book, $response);
    }

    /**
     * @test
     */
    public function itShouldThrowBookNotExistsException(): void
    {
        $repository = \Mockery::mock(BookRepository::class);
        $finder     = new BookFinder($repository);
        $request    = BookFinderRequestMother::random();

        $repository->shouldReceive('find')
            ->with($request->id())
            ->once()
            ->andReturnNull();

        $this->expectException(BookNotExistsException::class);

        ($finder)($request);
    }
}
